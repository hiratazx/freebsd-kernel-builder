name: Build FreeBSD 15 Kernel (Native)

on:
  workflow_dispatch:
    inputs:
      kernel_type:
        description: 'Target Environment'
        required: true
        default: 'qemu'
        type: choice
        options:
          - qemu
          - normal

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write 

    steps:
      - name: ðŸš€ Build Kernel inside Native FreeBSD VM
        uses: vmactions/freebsd-builder@v3
        with:
          usesh: true
          # This entire block executes natively inside a FreeBSD 14/15 environment
          run: |
            pkg install -y git
            
            echo "===> Cloning Source..."
            # Fetching releng/15.0 directly to the VM's /usr/src
            git clone -b releng/15.0 --depth 1 https://git.freebsd.org/src.git /usr/src
            
            echo "===> Configuring Kernel..."
            cd /usr/src/sys/amd64/conf
            
            if [ "${{ github.event.inputs.kernel_type }}" = "qemu" ]; then
              echo "include MINIMAL" > CUSTOM_KERNEL
              echo "ident QEMU_MICRO" >> CUSTOM_KERNEL
              echo "device virtio" >> CUSTOM_KERNEL
              echo "device virtio_pci" >> CUSTOM_KERNEL
              echo "device vtnet" >> CUSTOM_KERNEL
              echo "device vtblk" >> CUSTOM_KERNEL
              echo "device virtio_scsi" >> CUSTOM_KERNEL
              echo "device virtio_balloon" >> CUSTOM_KERNEL
              echo "device virtio_random" >> CUSTOM_KERNEL
              echo "device uart" >> CUSTOM_KERNEL
            else
              cp GENERIC CUSTOM_KERNEL
              # FreeBSD's native sed requires an empty string argument for in-place edits without backups
              sed -i '' 's/ident.*GENERIC/ident NORMAL_KERNEL/' CUSTOM_KERNEL
            fi
            
            echo "===> Building Kernel (Skipping Toolchain!)..."
            cd /usr/src
            # Use native sysctl to dynamically grab the number of CPU cores allocated to the VM
            make -j$(sysctl -n hw.ncpu) buildkernel KERNCONF=CUSTOM_KERNEL
            
            echo "===> Exporting Kernel..."
            mkdir -p /tmp/kernel-out
            make installkernel KERNCONF=CUSTOM_KERNEL DESTDIR=/tmp/kernel-out
            
            echo "===> Compressing..."
            cd /tmp/kernel-out/boot
            # The VM automatically syncs $GITHUB_WORKSPACE with the Ubuntu host runner
            tar -czvf $GITHUB_WORKSPACE/freebsd-15-${{ github.event.inputs.kernel_type }}-kernel.tar.gz kernel/

      - name: ðŸ“ Generate Changelog
        run: |
          echo "## FreeBSD 15 Custom Kernel Build" > release_notes.md
          echo "" >> release_notes.md
          echo "Built natively using a FreeBSD GitHub Action runner, bypassing cross-compilation entirely." >> release_notes.md
          echo "" >> release_notes.md
          echo "- **Kernel Type:** \`${{ github.event.inputs.kernel_type }}\`" >> release_notes.md
          echo "- **Branch:** \`releng/15.0\`" >> release_notes.md

      - name: ðŸ“¤ Upload to GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          tag_name: kernel-${{ github.event.inputs.kernel_type }}-${{ github.run_number }}
          name: FreeBSD 15 Kernel (${{ github.event.inputs.kernel_type }}) - Build ${{ github.run_number }}
          body_path: release_notes.md
          files: freebsd-15-${{ github.event.inputs.kernel_type }}-kernel.tar.gz
