name: Build FreeBSD 15 Kernel

on:
  workflow_dispatch:
    inputs:
      kernel_type:
        description: 'Target Environment'
        required: true
        default: 'qemu'
        type: choice
        options:
          - qemu
          - normal

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write 

    steps:
      - name: ðŸ› ï¸ Install Toolchain & Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang lld git python3 make libncurses-dev bison flex libssl-dev pkg-config zlib1g-dev libzstd-dev libarchive-dev libbz2-dev liblzma-dev

      - name: ðŸ—„ï¸ Cache FreeBSD Source
        uses: actions/cache@v4
        with:
          path: freebsd-src
          key: freebsd-src-15.0-${{ github.run_id }}
          restore-keys: |
            freebsd-src-15.0-

      - name: ðŸ“¥ Fetch FreeBSD 15 Source
        run: |
          if [ -d "freebsd-src/.git" ]; then
            echo "Source cache found! Pulling latest changes instead of re-cloning..."
            cd freebsd-src
            git pull --depth 1 origin releng/15.0
          else
            echo "No cache found. Cloning fresh source..."
            git clone -b releng/15.0 --depth 1 https://git.freebsd.org/src.git freebsd-src
          fi

      - name: âš™ï¸ Generate Kernel Configuration
        run: |
          cd freebsd-src/sys/amd64/conf
          
          if [ "${{ github.event.inputs.kernel_type }}" == "qemu" ]; then
            echo "Creating QEMU Micro configuration..."
            echo "include MINIMAL" > CUSTOM_KERNEL
            echo "ident QEMU_MICRO" >> CUSTOM_KERNEL
            echo "device virtio" >> CUSTOM_KERNEL
            echo "device virtio_pci" >> CUSTOM_KERNEL
            echo "device vtnet" >> CUSTOM_KERNEL
            echo "device vtblk" >> CUSTOM_KERNEL
            echo "device virtio_scsi" >> CUSTOM_KERNEL
            echo "device virtio_balloon" >> CUSTOM_KERNEL
            echo "device virtio_random" >> CUSTOM_KERNEL
            echo "device uart" >> CUSTOM_KERNEL
          else
            echo "Using default GENERIC configuration for normal hardware..."
            cp GENERIC CUSTOM_KERNEL
            sed -i 's/ident.*GENERIC/ident NORMAL_KERNEL/' CUSTOM_KERNEL
          fi

      - name: ðŸ—ï¸ Build Kernel Toolchain
        run: |
          cd freebsd-src
          mkdir -p ~/freebsd-obj
          
          export XCC=clang XCXX=clang++ XCPP="clang -E" XLD=ld.lld XAR=llvm-ar XNM=llvm-nm XOBJCOPY=llvm-objcopy XRANLIB=llvm-ranlib XSTRIP=llvm-strip
          MAKEOBJDIRPREFIX=~/freebsd-obj ./tools/build/make.py --cross-bindir=/usr/bin -j$(nproc) TARGET=amd64 TARGET_ARCH=amd64 kernel-toolchain

      - name: ðŸš€ Build Kernel
        run: |
          cd freebsd-src
          
          export XCC=clang XCXX=clang++ XCPP="clang -E" XLD=ld.lld XAR=llvm-ar XNM=llvm-nm XOBJCOPY=llvm-objcopy XRANLIB=llvm-ranlib XSTRIP=llvm-strip
          MAKEOBJDIRPREFIX=~/freebsd-obj ./tools/build/make.py --cross-bindir=/usr/bin -j$(nproc) TARGET=amd64 TARGET_ARCH=amd64 buildkernel KERNCONF=CUSTOM_KERNEL

      - name: ðŸ“¦ Export and Compress Kernel
        run: |
          cd freebsd-src
          mkdir -p ~/freebsd-kernel-out
          
          export XCC=clang XCXX=clang++ XCPP="clang -E" XLD=ld.lld XAR=llvm-ar XNM=llvm-nm XOBJCOPY=llvm-objcopy XRANLIB=llvm-ranlib XSTRIP=llvm-strip
          MAKEOBJDIRPREFIX=~/freebsd-obj ./tools/build/make.py TARGET=amd64 TARGET_ARCH=amd64 installkernel KERNCONF=CUSTOM_KERNEL DESTDIR=~/freebsd-kernel-out
          
          cd ~/freebsd-kernel-out/boot
          tar -czvf /tmp/freebsd-15-${{ github.event.inputs.kernel_type }}-kernel.tar.gz kernel/

      - name: ðŸ“ Generate Changelog
        run: |
          echo "## FreeBSD 15 Custom Kernel Build" > /tmp/release_notes.md
          echo "" >> /tmp/release_notes.md
          echo "Automated cross-compiled build from Ubuntu." >> /tmp/release_notes.md
          echo "" >> /tmp/release_notes.md
          echo "- **Kernel Type:** \`${{ github.event.inputs.kernel_type }}\`" >> /tmp/release_notes.md
          echo "- **Branch:** \`releng/15.0\`" >> /tmp/release_notes.md

      - name: ðŸ“¤ Upload to GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          tag_name: kernel-${{ github.event.inputs.kernel_type }}-${{ github.run_number }}
          name: FreeBSD 15 Kernel (${{ github.event.inputs.kernel_type }}) - Build ${{ github.run_number }}
          body_path: /tmp/release_notes.md
          files: /tmp/freebsd-15-${{ github.event.inputs.kernel_type }}-kernel.tar.gz
